{% extends 'base/base.html' %}
{% load humanize %}
{% load static %}
{% load mathfilters %}
{% block title %}
Phishing Detection
{% endblock title %}

{% block custom_js_css_link %}
<link rel="stylesheet" type="text/css" href="{% static 'custom/custom.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'plugins/j-map/jquery-jvectormap.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.3/css/flag-icons.min.css" integrity="sha512-uvXdJud8WaOlQFjlz9B15Yy2Au/bMAvz79F7Xa6OakCl2jvQPdHD0hb3dEqZRdSwG4/sknePXlE7GiarwA/9Wg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock custom_js_css_link %}

{% block breadcrumb_title %}
<span class="badge badge-soft-info">reNgine 2.1.3</span>
{% endblock breadcrumb_title %}

{% block main_content %}
<div class="row justify-content-center">
	<div class="col-xl-8 col-lg-8 col-sm-8">
		<div class="wrapper">
			<div class="search-input" id="phishing-search-input">
				<a href="" target="_blank" hidden></a>
				<div class="input-group">
					<input type="text" class="form-control" placeholder="http:// or https://" aria-label="Check your website" id="phishing-input">
					<div class="input-group-append">
						<button id="phishing-search-button" class="btn btn-primary" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Check</button>
					</div>
				</div>
				<div class="autocom-box mt-container mx-auto vulnerability-search" id="autocom-box">
				</div>
			</div>
		</div>
		<div class="message-notification-wrapper">
			<div id="safe" class="text-success h3"></div>
			<div id="warning" class="text-warning h3"></div>
			<div id="error" class="text-danger h3"></div>
		</div>
	</div>
</div>
{% endblock main_content %}

{% block page_level_script %}
<script type="text/javascript">
	$(document).ready(function() {
		web_input = $('#phishing-input')
		search_button = $('#phishing-search-button')
		safe = $("#safe")
		warning = $("#warning")
		error = $("#error")

		function validate_url(url) {
			try {
				url = url.trim()
				if (!url) {
					return [null, Error("Domain or IP must not be empty")]
				}
				url = new URL(url)
				return [url, null] 
			} catch (e) {
				return [null, Error("Invalid URL")]
			}
		}

		function clear() {
			safe.text(null)
			warning.text(null)
			error.text(null)
		}

		function on_search(input, func) {
			swal.fire({
				title:"Checking phishing website",
				text: `Please wait while we're checking website: ${input}`,
				padding: '2em',
				onOpen: function() {
					do_search(input)
				}
			})
		}
	
		function do_search(input_search) {
			clear()

			const [url_object, e] = validate_url(input_search)

			if (e) {
				error.text(e.toString())
				return
			}
			
			swal.showLoading()
			fetch('/api/phishing/predict/', {
				method: "POST",
				credentials: "same-origin",
				body: JSON.stringify({
					search: {
						domain: url_object.host,
						origin: url_object.href,
					},
				}),
				headers: {
					"X-CSRFToken": getCookie("csrftoken"),
					"Content-Type": 'application/json',
				}
			}).then(res => res.json())
			.then(data => {
				swal.close();
				benign = data?.benign
				phishing = data?.phishing
				threshold = data?.threshold

				if (!benign || !phishing){
					error.text("Unknown website")
					return
				}

				if(phishing < threshold){
					safe.text("This website is not a phishing website")
					return
				}
				
				console.log(data.data)
				warning.text(`This website is considered a phishing website (${Math.ceil(phishing * 100)}%)`)
			})
			.catch(err => {
				console.log(err);
				error.text("Something went wrong")
				swal.close();
			})
		}
	
		web_input.on('keypress', function(event) {
			if (event.which == 13) {
				on_search($(this).val())
			}
		})
		search_button.on('click', function(event) {
			on_search(web_input.val())
		})
	})
</script>
{% endblock page_level_script %}